# 事件循环

## 进程和线程

- 进程
  - CPU 承担了所有的计算任务
  - 进程是 CPU 资源分配的最小单位
  - 在同一个时间内，单个 CPU 只能执行一个任务，只能运行一个进程
  - 如果有一个进程正在执行，其它进程就得暂停
  - CPU 使用了时间片轮转的算法实现多进程的调度
- 线程

  - 线程是 CPU 调度的最小单位
  - 一个进程可以包括多个线程，这些线程共享这个进程资源

  ## Chrome

  - 浏览器是多进程的
  - 每一个 Tab 页就是一个进程
  - 浏览器主进程
    - 控制其他子进程的创建和销毁
    - 浏览器界面显示，比如用户交互、前进、后退等操作
    - 将渲染的内容绘制到用户界面上
  - 渲染进程就是我们说的浏览器内核
    - 负责页面的渲染、脚本执行、事件处理
    - 每个 tab 页都有一个渲染进程
  - 网络进程 处理网络请求、文件访问等操作
  - GPU 进程 用于 3D 绘制
  - 第三方插件进程

## 渲染进程

- GUI 渲染线程
  - 渲染、布局和绘制页面
  - 当页面需要重绘和回流时，此线程就会执行
  - 与 JS 引擎互斥
- JS 引擎线程
  - 负责解析执行 JS 脚本
  - 只有一个 JS 引擎线程（单线程）
  - 与 GUI 渲染线程互斥
- 事件触发线程
  - 用来控制事件循环（鼠标点击、Ajax 等）
  - 当事件满足触发条件时，把事件放入到 JS 引擎所有的执行队列中
- 定时器触发线程
  - setInterval 和 setTimeout 所在的线程
  - 定时任务并不是由 JS 引擎计时，而是由定时触发线程来计时的
  - 定时完毕后会通知事件触发线程
- 异步 HTTP 请求线程
  - 浏览器有一个单独的线程处理 Ajax 请求
  - 当请求完毕后，如果有回调函数，会通知事件触发线程

## 宏任务

- 页面的大部分任务是在主任务上执行的，比如：
  - 渲染事件（DOM 解析、布局、绘制）
  - 用户交互（鼠标点击、页面缩放）
  - JavaScript 脚本执行
  - 网络请求
  - 文件读写
- 宏任务会添加消息到消息队列的尾部，当主线程执行到该消息的时候就会执行
- 每次从事件队列中获取一个事件回调并且放在执行栈中的就是一个宏任务，宏任务执行过程中不会执行其他内容
- 每次宏任务执行完毕后会进行 GUI 渲染线程的渲染，然后再执行下一个宏任务
- 宏任务：script setTimeout setInterval I/O UI rendering
- 宏任务颗粒度较大，不适合需要精确控制的任务
- 宏任务是由宿主方控制

## 微任务

- 宏任务结束后会进行渲染然后执行下一个宏任务
- 微任务是当前宏任务执行后立即执行的宏任务
- 当宏任务执行完，就到达了检查点，会先将执行期间所产生的所有微任务都执行完再去进行渲染
- 微任务是由 V8 引擎控制的，在创建全局执行上下文的时候，也会在 V8 引擎内部创建一个微任务队列
- 微任务：process.nextTick Promise Object.observe MutationObserver
